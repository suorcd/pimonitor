# Playback Pause Counter Fix

**Date:** 2026-01-11

## Problem
When pressing the space bar to pause audio playback, the playback paused correctly but the position counter continued to increment. This made it appear as though the audio was still playing when it was actually paused.

## Root Cause
The elapsed time calculation was based solely on `playback_start.elapsed()`, which continued to increase even when the audio was paused. There was no mechanism to track accumulated playback time separately from the current session.

## Solution
Implemented a pause-aware elapsed time tracking system:

1. **Added `paused_elapsed` field** to `AppState` (type: `Duration`)
   - Tracks the total accumulated playback time when paused
   - Initialized to `Duration::from_secs(0)` in `AppState::new()`
   - Reset to zero when starting new playback or stopping playback

2. **Updated pause logic** (space bar handler when paused=false)
   - Before pausing, accumulate the current session's elapsed time into `paused_elapsed`
   - Set `playback_start` to `None` to stop the timer
   - Pause the audio sink

3. **Updated resume logic** (space bar handler when paused=true)
   - Reset `playback_start` to current instant to start a new timing session
   - Keep `paused_elapsed` intact (preserves accumulated time)
   - Resume the audio sink

4. **Updated elapsed time calculation** (in status display)
   - Calculate total elapsed as: `paused_elapsed + current_session_elapsed`
   - Current session is `playback_start.elapsed()` if playing, or `Duration::from_secs(0)` if paused
   - This provides accurate position tracking across pause/resume cycles

## Files Modified
- `/home/brentano/git-repo/github.com/suorcd/pimonitor/src/main.rs`
  - Added `paused_elapsed: Duration` field to `AppState` struct
  - Updated `AppState::new()` to initialize `paused_elapsed`
  - Updated `AppState::stop_playback()` to reset `paused_elapsed`
  - Modified space bar pause/resume logic to track accumulated time
  - Updated `UiMsg::PlayReady` handler to reset `paused_elapsed` on new playback
  - Modified elapsed time calculation in status display to use accumulated time

## Testing
- Built successfully with `cargo build`
- All tests pass (14 tests across all test suites)

## Behavior
- Position counter now correctly freezes when playback is paused
- Position counter resumes counting from the paused position when playback is resumed
- Position counter resets to 0:00 when starting new audio playback
- Position counter resets when stopping playback
